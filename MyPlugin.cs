using System;
using System.Collections.Generic;
using System.ComponentModel.Composition;
using System.IO;
using System.Linq;
using System.Reflection;
using XrmToolBox.Extensibility;
using XrmToolBox.Extensibility.Interfaces;

namespace DataverseUserSecurity
{
    // Do not forget to update version number and author (company attribute) in AssemblyInfo.cs class
    // To generate Base64 string for Images below, you can use https://www.base64-image.de/
    [Export(typeof(IXrmToolBoxPlugin)),
        ExportMetadata("Name", "Dataverse Users, Security roles, Teams and Teams security roles"),
        ExportMetadata("Description", "This tool is used to retrieve and search for the Users Details, User security roles, User Teams and User Teams security roles"),
        // Please specify the base64 content of a 32x32 pixels image
        ExportMetadata("SmallImageBase64", "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"),
        // Please specify the base64 content of a 80x80 pixels image
        ExportMetadata("BigImageBase64", "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"),
        ExportMetadata("BackgroundColor", "White"),
        ExportMetadata("PrimaryFontColor", "Black"),
        ExportMetadata("SecondaryFontColor", "Gray")]
    public class MyPlugin : PluginBase
    {
        public override IXrmToolBoxPluginControl GetControl()
        {
            return new MyPluginControl();
        }

        /// <summary>
        /// Constructor 
        /// </summary>
        public MyPlugin()
        {
            // If you have external assemblies that you need to load, uncomment the following to 
            // hook into the event that will fire when an Assembly fails to resolve
            // AppDomain.CurrentDomain.AssemblyResolve += new ResolveEventHandler(AssemblyResolveEventHandler);
        }

        /// <summary>
        /// Event fired by CLR when an assembly reference fails to load
        /// Assumes that related assemblies will be loaded from a subfolder named the same as the Plugin
        /// For example, a folder named Sample.XrmToolBox.MyPlugin 
        /// </summary>
        /// <param name="sender"></param>
        /// <param name="args"></param>
        /// <returns></returns>
        private Assembly AssemblyResolveEventHandler(object sender, ResolveEventArgs args)
        {
            Assembly loadAssembly = null;
            Assembly currAssembly = Assembly.GetExecutingAssembly();

            // base name of the assembly that failed to resolve
            var argName = args.Name.Substring(0, args.Name.IndexOf(","));

            // check to see if the failing assembly is one that we reference.
            List<AssemblyName> refAssemblies = currAssembly.GetReferencedAssemblies().ToList();
            var refAssembly = refAssemblies.Where(a => a.Name == argName).FirstOrDefault();

            // if the current unresolved assembly is referenced by our plugin, attempt to load
            if (refAssembly != null)
            {
                // load from the path to this plugin assembly, not host executable
                string dir = Path.GetDirectoryName(currAssembly.Location).ToLower();
                string folder = Path.GetFileNameWithoutExtension(currAssembly.Location);
                dir = Path.Combine(dir, folder);

                var assmbPath = Path.Combine(dir, $"{argName}.dll");

                if (File.Exists(assmbPath))
                {
                    loadAssembly = Assembly.LoadFrom(assmbPath);
                }
                else
                {
                    throw new FileNotFoundException($"Unable to locate dependency: {assmbPath}");
                }
            }

            return loadAssembly;
        }
    }
}